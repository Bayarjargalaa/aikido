{% extends 'aikido_app/base.html' %}
{% load static %}

{% block title %}Гүйлгээ холбох{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-link mr-2 text-blue-600"></i>Банкны гүйлгээг сурагчтай холбох
        </h1>
        <p class="text-gray-600">Төлбөрийг сурагч болон сарт хуваарилна</p>
    </div>

    <!-- Transaction Info -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
                <p class="text-blue-100 text-sm mb-1">Огноо</p>
                <p class="text-2xl font-bold">{{ transaction.transaction_date|date:"Y-m-d" }}</p>
            </div>
            <div>
                <p class="text-blue-100 text-sm mb-1">Төрөл</p>
                {% if transaction.credit_amount and transaction.credit_amount > 0 %}
                <p class="text-2xl font-bold">
                    <i class="fas fa-arrow-down mr-2"></i>Орлого
                </p>
                {% elif transaction.debit_amount and transaction.debit_amount != 0 %}
                <p class="text-2xl font-bold">
                    <i class="fas fa-arrow-up mr-2"></i>Зардал
                </p>
                {% else %}
                <p class="text-2xl font-bold text-gray-300">—</p>
                {% endif %}
            </div>
            <div>
                <p class="text-blue-100 text-sm mb-1">Нийт дүн</p>
                {% if transaction.credit_amount and transaction.credit_amount > 0 %}
                <p class="text-3xl font-bold text-green-300">+{{ transaction.credit_amount|floatformat:0 }}₮</p>
                {% elif transaction.debit_amount and transaction.debit_amount != 0 %}
                <p class="text-3xl font-bold text-red-300">{{ transaction.debit_amount|floatformat:0 }}₮</p>
                {% else %}
                <p class="text-3xl font-bold">{{ transaction.amount|floatformat:0 }}₮</p>
                {% endif %}
            </div>
            <div>
                <p class="text-blue-100 text-sm mb-1">Үлдсэн дүн</p>
                <p class="text-3xl font-bold text-yellow-300" id="remaining-amount">
                    {{ remaining_amount|floatformat:0 }}₮
                </p>
            </div>
        </div>
        {% if transaction.counterparty_account %}
        <div class="mt-4 pt-4 border-t border-blue-400">
            <p class="text-blue-100 text-sm mb-1">Харьцсан данс</p>
            <p class="text-lg font-semibold">{{ transaction.counterparty_account }}</p>
        </div>
        {% endif %}
        {% if transaction.description %}
        <div class="mt-2">
            <p class="text-blue-100 text-sm mb-1">Гүйлгээний утга</p>
            <p class="text-sm">{{ transaction.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Existing Allocations -->
    {% if is_income and allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list mr-2 text-green-600"></i>Одоо байгаа сурагчдын төлбөрийн хуваарилалт
        </h2>
        <div class="space-y-3">
            {% for allocation in allocations %}
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-user-circle text-green-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.student }}</p>
                        <p class="text-sm text-gray-600">{{ allocation.payment_month|date:"Y оны m сар" }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-green-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'delete_payment_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if is_income and income_allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list mr-2 text-purple-600"></i>Одоо байгаа бусад орлогын хуваарилалт
        </h2>
        <div class="space-y-3">
            {% for allocation in income_allocations %}
            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-hand-holding-usd text-purple-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.income_category.name }}</p>
                        <p class="text-sm text-gray-600">{{ allocation.income_date|date:"Y-m-d" }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'delete_income_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if is_income and seminar_allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list mr-2 text-orange-600"></i>Одоо байгаа семинарын төлбөр
        </h2>
        <div class="space-y-3">
            {% for allocation in seminar_allocations %}
            <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-chalkboard-teacher text-orange-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.student }} - {{ allocation.seminar.name }}</p>
                        <p class="text-sm text-gray-600">{{ allocation.seminar.seminar_date|date:"Y-m-d" }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-orange-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'delete_seminar_payment_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if is_income and membership_allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list mr-2 text-green-600"></i>Одоо байгаа гишүүнчлэлийн төлбөр
        </h2>
        <div class="space-y-3">
            {% for allocation in membership_allocations %}
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-id-card text-green-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.student }}</p>
                        <p class="text-sm text-gray-600">{{ allocation.payment_month|date:"Y оны m сар" }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-green-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'delete_membership_payment_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if is_expense %}
    <!-- Linked Instructor Payments -->
    {% with transaction.instructor_payments.all as instructor_payments %}
    {% if instructor_payments %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-chalkboard-teacher mr-2 text-blue-600"></i>Холбогдсон багшийн төлбөр
        </h2>
        <div class="space-y-3">
            {% for payment in instructor_payments %}
            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-user-circle text-blue-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ payment.instructor }}</p>
                        <p class="text-sm text-gray-600">
                            {{ payment.class_type.get_name_display }} - {{ payment.month|date:"Y-m" }} - {{ payment.get_role_display }}
                        </p>
                        <p class="text-xs text-gray-500">{{ payment.total_classes }} хичээл</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-blue-600">{{ payment.instructor_share_amount|floatformat:0 }}₮</p>
                        {% if payment.paid_date %}
                        <p class="text-xs text-gray-500">{{ payment.paid_date|date:"Y-m-d" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}

    <!-- Linked Federation Payments -->
    {% with transaction.federation_payments.all as federation_payments %}
    {% if federation_payments %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-university mr-2 text-purple-600"></i>Холбогдсон холбооны төлбөр
        </h2>
        <div class="space-y-3">
            {% for payment in federation_payments %}
            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-building text-purple-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ payment.class_type.get_name_display }}</p>
                        <p class="text-sm text-gray-600">{{ payment.month|date:"Y-m" }}</p>
                        <p class="text-xs text-gray-500">Нийт: {{ payment.total_payment_collected|floatformat:0 }}₮</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-600">{{ payment.federation_share_amount|floatformat:0 }}₮</p>
                        {% if payment.paid_date %}
                        <p class="text-xs text-gray-500">{{ payment.paid_date|date:"Y-m-d" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}

    {% if expense_allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list mr-2 text-red-600"></i>Одоо байгаа зардлын хуваарилалт
        </h2>
        <div class="space-y-3">
            {% for allocation in expense_allocations %}
            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-receipt text-red-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.expense_category }}</p>
                        <p class="text-sm text-gray-600">{{ allocation.expense_date|date:"Y-m-d" }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-red-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'delete_expense_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Instructor Payment Allocations -->
    {% if is_expense and instructor_payment_allocations %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-chalkboard-teacher mr-2 text-purple-600"></i>Багшийн төлбөрийн хуваарилалтууд
        </h2>
        <div class="space-y-3">
            {% for allocation in instructor_payment_allocations %}
            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div class="flex items-center gap-4">
                    <i class="fas fa-user-tie text-purple-600 text-2xl"></i>
                    <div>
                        <p class="font-semibold text-gray-800">{{ allocation.instructor_payment.instructor }}</p>
                        <p class="text-sm text-gray-600">
                            {{ allocation.instructor_payment.class_type.get_name_display }} - 
                            {{ allocation.instructor_payment.month|date:"Y-m" }} - 
                            {{ allocation.instructor_payment.get_role_display }}
                        </p>
                        <p class="text-xs text-gray-500">
                            Нийт: {{ allocation.instructor_payment.instructor_share_amount|floatformat:0 }}₮ / 
                            Төлсөн: {{ allocation.instructor_payment.paid_amount|floatformat:0 }}₮
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-600">{{ allocation.amount|floatformat:0 }}₮</p>
                        {% if allocation.notes %}
                        <p class="text-xs text-gray-500">{{ allocation.notes }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-400">{{ allocation.created_at|date:"Y-m-d H:i" }}</p>
                    </div>
                    <form method="post" action="{% url 'delete_instructor_payment_allocation' allocation.id %}" 
                          onsubmit="return confirm('Энэ хуваарилалтыг устгах уу?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Add New Allocations -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
            {% if is_income %}Шинэ орлогын хуваарилалт нэмэх{% else %}Шинэ зардлын хуваарилалт нэмэх{% endif %}
        </h2>
        
        <form method="post" id="allocation-form">
            {% csrf_token %}
            
            {% if is_income %}
            <!-- Income Type Selection -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-list-ul mr-1"></i>Орлогын төрөл сонгох
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="income_type" value="student_payment" checked
                               class="mr-2" onchange="toggleIncomeForm()">
                        <span class="text-sm font-medium">Сургалтын төлбөр</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="income_type" value="seminar_payment"
                               class="mr-2" onchange="toggleIncomeForm()">
                        <span class="text-sm font-medium">Семинарын төлбөр</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="income_type" value="membership_payment"
                               class="mr-2" onchange="toggleIncomeForm()">
                        <span class="text-sm font-medium">Гишүүнчлэлийн төлбөр</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="income_type" value="other_income"
                               class="mr-2" onchange="toggleIncomeForm()">
                        <span class="text-sm font-medium">Бусад орлого</span>
                    </label>
                </div>
            </div>
            
            <!-- Student Payment Form (default visible) -->
            <div id="student-payment-form">
            <!-- Income (Payment) Allocation Form -->
            <div id="allocation-rows" class="space-y-4 mb-6">
                <!-- Initial row -->
                <div class="allocation-row grid grid-cols-1 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>Сурагч
                        </label>
                        <select name="student_id[]" required
                                class="student-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Сонгох --</option>
                            {% for student in students %}
                            <option value="{{ student.id }}" data-monthly-fee="{{ student.monthly_fee }}">
                                {{ student.first_name }} {{ student.last_name }} 
                                {% if student.monthly_fee %}
                                ({{ student.monthly_fee|floatformat:0 }}₮/сар)
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Сар
                        </label>
                        <input type="month" name="payment_month[]" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-money-bill mr-1"></i>Дүн (₮)
                        </label>
                        <input type="number" name="amount[]" step="0.01" required
                               class="amount-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="0">
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="removeRow(this)" 
                                class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment mr-1"></i>Тайлбар (заавал биш)
                        </label>
                        <input type="text" name="notes[]"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Тайлбар бичих...">
                    </div>
                </div>
            </div>

            <!-- Add Row Button -->
            <button type="button" onclick="addRow()" 
                    class="w-full py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 border-2 border-dashed border-blue-300 mb-6">
                <i class="fas fa-plus-circle mr-2"></i>Мөр нэмэх
            </button>

            <!-- Quick Fill Section -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
                <h3 class="text-sm font-semibold text-yellow-800 mb-3">
                    <i class="fas fa-magic mr-2"></i>Олон сар автоматаар нөхөх
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-gray-700 mb-1">Сурагч сонгох</label>
                        <select id="quick-student" class="w-full px-3 py-2 border rounded text-sm">
                            <option value="">-- Сонгох --</option>
                            {% for student in students %}
                            <option value="{{ student.id }}" data-monthly-fee="{{ student.monthly_fee }}">
                                {{ student.first_name }} {{ student.last_name }} .
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-700 mb-1">Хэдэн сар?</label>
                        <input type="number" id="quick-months" min="1" max="12" value="1" 
                               class="w-full px-3 py-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-700 mb-1">Эхлэх сар</label>
                        <input type="month" id="quick-start-month" 
                               class="w-full px-3 py-2 border rounded text-sm">
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="quickFill()" 
                                class="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                            <i class="fas fa-bolt mr-1"></i>Нөхөх
                        </button>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Student Payment Form -->

            <!-- Other Income Form (hidden by default) -->
            <div id="other-income-form" style="display: none;">
                <div id="income-allocation-rows" class="space-y-4 mb-6">
                    <!-- Initial row -->
                    <div class="income-row grid grid-cols-1 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-tag mr-1"></i>Орлогын төрөл
                            </label>
                            <select name="income_category[]" disabled
                                    class="category-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">-- Одоо байгаа төрөл --</option>
                                {% for category in income_categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="new_income_category[]" disabled
                                   class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   placeholder="Эсвэл шинэ төрөл үүсгэх...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-1"></i>Огноо
                            </label>
                            <input type="date" name="income_date[]" disabled value="{{ transaction.transaction_date|date:'Y-m-d' }}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-bill mr-1"></i>Дүн (₮)
                            </label>
                            <input type="number" name="amount[]" step="0.01" disabled
                                   class="amount-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   placeholder="0">
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="removeIncomeRow(this)" 
                                    class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="md:col-span-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment mr-1"></i>Тайлбар (заавал биш)
                            </label>
                            <input type="text" name="notes[]" disabled
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   placeholder="Тайлбар бичих...">
                        </div>
                    </div>
                </div>

                <!-- Add Row Button for Other Income -->
                <button type="button" onclick="addIncomeRow()" 
                        class="w-full py-3 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 border-2 border-dashed border-purple-300 mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>Мөр нэмэх
                </button>
            </div>
            <!-- End Other Income Form -->

            <!-- Seminar Payment Form (hidden by default) -->
            <div id="seminar-payment-form" style="display: none;">
                <div id="seminar-allocation-rows" class="space-y-4 mb-6">
                    <!-- Initial row -->
                    <div class="seminar-row grid grid-cols-1 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1"></i>Сурагч
                            </label>
                            <select name="seminar_student_id[]" disabled
                                    class="seminar-student-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">-- Сонгох --</option>
                                {% for student in students %}
                                <option value="{{ student.id }}">
                                    {{ student.first_name }} {{ student.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-chalkboard-teacher mr-1"></i>Семинар
                            </label>
                            <select name="seminar_id[]" disabled
                                    class="seminar-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">-- Сонгох --</option>
                                {% for seminar in seminars %}
                                <option value="{{ seminar.id }}" data-fee="{{ seminar.fee }}">
                                    {{ seminar.name }} ({{ seminar.seminar_date|date:"Y-m-d" }})
                                    {% if seminar.fee %}
                                    - {{ seminar.fee|floatformat:0 }}₮
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-bill mr-1"></i>Дүн (₮)
                            </label>
                            <input type="number" name="amount[]" step="0.01" disabled
                                   class="amount-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                   placeholder="0">
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment mr-1"></i>Тайлбар (заавал биш)
                            </label>
                            <input type="text" name="notes[]" disabled
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                   placeholder="Тайлбар бичих...">
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="removeSeminarRow(this)" 
                                    class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Row Button for Seminar -->
                <button type="button" onclick="addSeminarRow()" 
                        class="w-full py-3 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 border-2 border-dashed border-orange-300 mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>Мөр нэмэх
                </button>
            </div>
            <!-- End Seminar Payment Form -->

            <!-- Membership Payment Form (hidden by default) -->
            <div id="membership-payment-form" style="display: none;">
                <div id="membership-allocation-rows" class="space-y-4 mb-6">
                    <!-- Initial row -->
                    <div class="membership-row grid grid-cols-1 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1"></i>Сурагч
                            </label>
                            <select name="membership_student_id[]" disabled
                                    class="membership-student-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">-- Сонгох --</option>
                                {% for student in students %}
                                <option value="{{ student.id }}">
                                    {{ student.first_name }} {{ student.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-1"></i>Сар
                            </label>
                            <input type="month" name="membership_month[]" disabled
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-bill mr-1"></i>Дүн (₮)
                            </label>
                            <input type="number" name="amount[]" step="0.01" disabled
                                   class="amount-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="0">
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="removeMembershipRow(this)" 
                                    class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="md:col-span-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment mr-1"></i>Тайлбар (заавал биш)
                            </label>
                            <input type="text" name="notes[]" disabled
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="Тайлбар бичих...">
                        </div>
                    </div>
                </div>

                <!-- Add Row Button for Membership -->
                <button type="button" onclick="addMembershipRow()" 
                        class="w-full py-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 border-2 border-dashed border-green-300 mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>Мөр нэмэх
                </button>
            </div>
            <!-- End Membership Payment Form -->
            
            {% elif is_expense %}
            <!-- Expense Type Selection -->
            <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-list-ul mr-1"></i>Зардлын төрөл сонгох
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="expense_type" value="regular" checked
                               class="mr-2" onchange="toggleExpenseForm()">
                        <span class="text-sm font-medium">Энгийн зардал</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="expense_type" value="instructor_payment"
                               class="mr-2" onchange="toggleExpenseForm()">
                        <span class="text-sm font-medium">Багшийн цалин</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="expense_type" value="federation_payment"
                               class="mr-2" onchange="toggleExpenseForm()">
                        <span class="text-sm font-medium">Холбооны төлбөр</span>
                    </label>
                </div>
            </div>

            <!-- Regular Expense Allocation Form -->
            <div id="regular-expense-form">
            <div id="expense-rows" class="space-y-4 mb-6">
                <!-- Initial row -->
                <div class="expense-row grid grid-cols-1 md:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-1"></i>Зардлын ангилал
                        </label>
                        <select name="expense_category[]" 
                                class="category-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Одоо байгаа ангилал --</option>
                            {% for category in expense_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="new_category[]" 
                               class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Эсвэл шинэ ангилал үүсгэх...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Огноо
                        </label>
                        <input type="date" name="expense_date[]" required value="{{ transaction.transaction_date|date:'Y-m-d' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-money-bill mr-1"></i>Дүн (₮)
                        </label>
                        <input type="number" name="amount[]" step="0.01" required
                               class="amount-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="0">
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="removeExpenseRow(this)" 
                                class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment mr-1"></i>Тайлбар (заавал биш)
                        </label>
                        <input type="text" name="notes[]"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Тайлбар бичих...">
                    </div>
                </div>
            </div>

            <!-- Add Row Button for Expense -->
            <button type="button" onclick="addExpenseRow()" 
                    class="w-full py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 border-2 border-dashed border-blue-300 mb-6">
                <i class="fas fa-plus-circle mr-2"></i>Мөр нэмэх
            </button>
            </div>
            <!-- End Regular Expense Form -->

            <!-- Instructor Payment Form -->
            <div id="instructor-payment-form" style="display:none;">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-chalkboard-teacher mr-2 text-blue-600"></i>Багшийн цалин олгох (Хэсэгчлэн төлөх боломжтой)
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Төлбөр олгох багш нарыг сонгоод дүн оруулна уу</p>
                    
                    <div id="instructor-payment-rows" class="space-y-3 max-h-96 overflow-y-auto">
                        {% for payment in unpaid_instructor_payments %}
                        <div class="p-4 bg-white rounded-lg border border-gray-300">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                                <div class="md:col-span-2">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" class="instructor-payment-checkbox mr-3 w-5 h-5 text-blue-600"
                                               onclick="toggleInstructorPaymentAmount(this, {{ payment.id }})">
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-900">{{ payment.instructor }}</p>
                                            <p class="text-sm text-gray-600">
                                                {{ payment.class_type.get_name_display }} - {{ payment.month|date:"Y-m" }} - {{ payment.get_role_display }}
                                            </p>
                                            <p class="text-xs text-gray-500">{{ payment.total_classes }} хичээл</p>
                                        </div>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Төлбөр</label>
                                    <p class="text-sm">
                                        <span class="text-gray-600">Нийт:</span> 
                                        <span class="font-bold text-blue-600">{{ payment.instructor_share_amount|floatformat:0 }}₮</span>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        Үлдсэн: <span class="font-semibold">{{ payment.get_remaining_amount|floatformat:0 }}₮</span>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Төлөх дүн (₮)</label>
                                    <input type="number" 
                                           id="instructor-payment-amount-{{ payment.id }}"
                                           name="instructor_payment_amount[]" 
                                           step="0.01" 
                                           max="{{ payment.get_remaining_amount }}"
                                           value="{{ payment.get_remaining_amount }}"
                                           disabled
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm bg-gray-100"
                                           placeholder="0">
                                    <input type="hidden" id="instructor-payment-id-{{ payment.id }}" name="instructor_payment_id[]" value="" disabled>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Тайлбар</label>
                                <input type="text" 
                                       id="instructor-payment-notes-{{ payment.id }}"
                                       name="instructor_payment_notes[]" 
                                       disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm bg-gray-100"
                                       placeholder="Тайлбар...">
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Олгоогүй багшийн төлбөр байхгүй</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- End Instructor Payment Form -->

            <!-- Federation Payment Form -->
            <div id="federation-payment-form" style="display:none;">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-university mr-2 text-purple-600"></i>Холбооны төлбөр олгох
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Төлбөр олгох холбооны хуваарилалтыг сонгоно уу</p>
                    
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        {% for payment in unpaid_federation_payments %}
                        <label class="flex items-center p-4 bg-white rounded-lg border border-gray-300 hover:bg-purple-50 cursor-pointer">
                            <input type="checkbox" name="federation_payment_id[]" value="{{ payment.id }}"
                                   class="mr-4 w-5 h-5 text-purple-600">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-900">{{ payment.class_type.get_name_display }}</p>
                                        <p class="text-sm text-gray-600">{{ payment.month|date:"Y-m" }}</p>
                                        <p class="text-xs text-gray-500">Нийт цуглуулсан: {{ payment.total_payment_collected|floatformat:0 }}₮</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xl font-bold text-purple-600">{{ payment.federation_share_amount|floatformat:0 }}₮</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                        {% empty %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Олгоогүй холбооны төлбөр байхгүй</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- End Federation Payment Form -->
            {% endif %}

            <!-- Actions -->
            <div class="flex gap-4">
                <button type="submit" 
                        class="flex-1 inline-flex justify-center items-center px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white font-semibold rounded-lg shadow-lg hover:from-green-700 hover:to-blue-700 transition-all">
                    <i class="fas fa-save mr-2"></i>Хадгалах
                </button>
                <a href="{% url 'bank_transaction_list' %}" 
                   class="inline-flex justify-center items-center px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all">
                    <i class="fas fa-times mr-2"></i>Болих
                </a>
            </div>
        </form>
    </div>
</div>

<script>
const transactionAmount = {{ transaction.amount }};
const allocatedAmount = {{ transaction.get_allocated_amount }};

function addRow() {
    const container = document.getElementById('allocation-rows');
    const firstRow = container.querySelector('.allocation-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
    
    container.appendChild(newRow);
    updateRemainingAmount();
}

function removeRow(button) {
    const container = document.getElementById('allocation-rows');
    if (container.querySelectorAll('.allocation-row').length > 1) {
        button.closest('.allocation-row').remove();
        updateRemainingAmount();
    } else {
        alert('Хамгийн багадаа 1 мөр байх ёстой');
    }
}

function updateRemainingAmount() {
    let total = allocatedAmount;
    document.querySelectorAll('.amount-input').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    const remaining = transactionAmount - total;
    document.getElementById('remaining-amount').textContent = remaining.toFixed(0) + '₮';
    
    if (remaining < 0) {
        document.getElementById('remaining-amount').classList.add('text-red-500');
        document.getElementById('remaining-amount').classList.remove('text-yellow-300');
    } else {
        document.getElementById('remaining-amount').classList.remove('text-red-500');
        document.getElementById('remaining-amount').classList.add('text-yellow-300');
    }
}

// Update remaining on amount change
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('amount-input')) {
        updateRemainingAmount();
    }
});

// Auto-fill monthly fee when student is selected
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('student-select')) {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const monthlyFee = selectedOption.dataset.monthlyFee;
        if (monthlyFee) {
            const row = e.target.closest('.allocation-row');
            const amountInput = row.querySelector('.amount-input');
            if (!amountInput.value) {
                amountInput.value = monthlyFee;
                updateRemainingAmount();
            }
        }
    }
});

// Quick fill multiple months
function quickFill() {
    const studentId = document.getElementById('quick-student').value;
    const months = parseInt(document.getElementById('quick-months').value) || 1;
    const startMonth = document.getElementById('quick-start-month').value;
    
    if (!studentId || !startMonth) {
        alert('Сурагч болон эхлэх сарыг сонгоно уу');
        return;
    }
    
    const studentSelect = document.getElementById('quick-student');
    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
    const monthlyFee = selectedOption.dataset.monthlyFee || 0;
    
    // Parse start month
    const [year, month] = startMonth.split('-').map(Number);
    
    // Clear existing rows except first
    const container = document.getElementById('allocation-rows');
    const rows = container.querySelectorAll('.allocation-row');
    for (let i = rows.length - 1; i > 0; i--) {
        rows[i].remove();
    }
    
    // Fill rows
    for (let i = 0; i < months; i++) {
        const currentDate = new Date(year, month - 1 + i, 1);
        const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        
        if (i === 0) {
            // Use first row
            const firstRow = container.querySelector('.allocation-row');
            firstRow.querySelector('.student-select').value = studentId;
            firstRow.querySelector('input[type="month"]').value = currentMonth;
            firstRow.querySelector('.amount-input').value = monthlyFee;
        } else {
            // Add new row
            addRow();
            const lastRow = container.lastElementChild;
            lastRow.querySelector('.student-select').value = studentId;
            lastRow.querySelector('input[type="month"]').value = currentMonth;
            lastRow.querySelector('.amount-input').value = monthlyFee;
        }
    }
    
    updateRemainingAmount();
}

// Set default start month to current month
document.getElementById('quick-start-month').value = new Date().toISOString().slice(0, 7);

// Form validation
document.getElementById('allocation-form').addEventListener('submit', function(e) {
    let total = allocatedAmount;
    document.querySelectorAll('.amount-input').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    
    if (total > transactionAmount) {
        if (!confirm(`Хуваарилсан дүн (${total.toFixed(0)}₮) нийт дүнгээс (${transactionAmount.toFixed(0)}₮) их байна. Үргэлжлүүлэх үү?`)) {
            e.preventDefault();
        }
    }
});

// Expense allocation functions
function addExpenseRow() {
    const container = document.getElementById('expense-rows');
    const firstRow = container.querySelector('.expense-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.type === 'text') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.type === 'date') {
            // Keep default date
        }
    });
    
    container.appendChild(newRow);
}

function removeExpenseRow(button) {
    const container = document.getElementById('expense-rows');
    if (container.querySelectorAll('.expense-row').length > 1) {
        button.closest('.expense-row').remove();
    } else {
        alert('Хамгийн багадаа 1 мөр байх ёстой');
    }
}

// Toggle between expense types
function toggleExpenseForm() {
    const expenseType = document.querySelector('input[name="expense_type"]:checked').value;
    const regularForm = document.getElementById('regular-expense-form');
    const instructorForm = document.getElementById('instructor-payment-form');
    const federationForm = document.getElementById('federation-payment-form');
    
    // Hide all forms
    regularForm.style.display = 'none';
    instructorForm.style.display = 'none';
    federationForm.style.display = 'none';
    
    // Disable all fields
    [regularForm, instructorForm, federationForm].forEach(form => {
        form.querySelectorAll('input, select').forEach(el => {
            el.disabled = true;
            el.required = false;
        });
    });
    
    // Show and enable selected form
    if (expenseType === 'regular') {
        regularForm.style.display = 'block';
        regularForm.querySelectorAll('input, select').forEach(el => {
            el.disabled = false;
            if (el.name === 'expense_date[]' || el.name === 'amount[]') {
                el.required = true;
            }
        });
    } else if (expenseType === 'instructor_payment') {
        instructorForm.style.display = 'block';
        // Enable only checkboxes - other inputs controlled by toggleInstructorPaymentAmount()
        instructorForm.querySelectorAll('input[type="checkbox"]').forEach(el => {
            el.disabled = false;
        });
    } else if (expenseType === 'federation_payment') {
        federationForm.style.display = 'block';
        federationForm.querySelectorAll('input[type="checkbox"]').forEach(el => {
            el.disabled = false;
        });
    }
}

// Toggle between payment types
function toggleIncomeForm() {
    const incomeType = document.querySelector('input[name="income_type"]:checked').value;
    const studentForm = document.getElementById('student-payment-form');
    const seminarForm = document.getElementById('seminar-payment-form');
    const membershipForm = document.getElementById('membership-payment-form');
    const otherIncomeForm = document.getElementById('other-income-form');
    
    // Hide all forms
    studentForm.style.display = 'none';
    seminarForm.style.display = 'none';
    membershipForm.style.display = 'none';
    otherIncomeForm.style.display = 'none';
    
    // Disable all fields
    [studentForm, seminarForm, membershipForm, otherIncomeForm].forEach(form => {
        form.querySelectorAll('input, select').forEach(el => {
            el.disabled = true;
            el.required = false;
        });
    });
    
    // Show and enable selected form
    if (incomeType === 'student_payment') {
        studentForm.style.display = 'block';
        studentForm.querySelectorAll('input, select').forEach(el => {
            el.disabled = false;
            if (el.name === 'student_id[]' || el.name === 'payment_month[]' || el.name === 'amount[]') {
                el.required = true;
            }
        });
    } else if (incomeType === 'seminar_payment') {
        seminarForm.style.display = 'block';
        seminarForm.querySelectorAll('input, select').forEach(el => {
            el.disabled = false;
            if (el.name === 'seminar_student_id[]' || el.name === 'seminar_id[]' || el.name === 'amount[]') {
                el.required = true;
            }
        });
    } else if (incomeType === 'membership_payment') {
        membershipForm.style.display = 'block';
        membershipForm.querySelectorAll('input, select').forEach(el => {
            el.disabled = false;
            if (el.name === 'membership_student_id[]' || el.name === 'membership_month[]' || el.name === 'amount[]') {
                el.required = true;
            }
        });
    } else if (incomeType === 'other_income') {
        otherIncomeForm.style.display = 'block';
        otherIncomeForm.querySelectorAll('input, select').forEach(el => {
            el.disabled = false;
            if (el.name === 'income_date[]' || el.name === 'amount[]') {
                el.required = true;
            }
        });
    }
}

// Other income allocation functions
function addIncomeRow() {
    const container = document.getElementById('income-allocation-rows');
    const firstRow = container.querySelector('.income-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.type === 'text') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.type === 'date') {
            // Keep default date
        }
    });
    
    container.appendChild(newRow);
}

function removeIncomeRow(button) {
    const container = document.getElementById('income-allocation-rows');
    if (container.querySelectorAll('.income-row').length > 1) {
        button.closest('.income-row').remove();
    } else {
        alert('Хамгийн багадаа 1 мөр байх ёстой');
    }
}

// Seminar payment functions
function addSeminarRow() {
    const container = document.getElementById('seminar-allocation-rows');
    const firstRow = container.querySelector('.seminar-row');
    const newRow = firstRow.cloneNode(true);
    
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.type === 'text') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
    });
    
    container.appendChild(newRow);
}

function removeSeminarRow(button) {
    const container = document.getElementById('seminar-allocation-rows');
    if (container.querySelectorAll('.seminar-row').length > 1) {
        button.closest('.seminar-row').remove();
    } else {
        alert('Хамгийн багадаа 1 мөр байх ёстой');
    }
}

// Membership payment functions
function addMembershipRow() {
    const container = document.getElementById('membership-allocation-rows');
    const firstRow = container.querySelector('.membership-row');
    const newRow = firstRow.cloneNode(true);
    
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.type === 'text') {
            input.value = '';
        } else if (input.type === 'month') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
    });
    
    container.appendChild(newRow);
}

function removeMembershipRow(button) {
    const container = document.getElementById('membership-allocation-rows');
    if (container.querySelectorAll('.membership-row').length > 1) {
        button.closest('.membership-row').remove();
    } else {
        alert('Хамгийн багадаа 1 мөр байх ёстой');
    }
}

// Auto-fill seminar fee when seminar selected
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('seminar-select')) {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const fee = selectedOption.dataset.fee;
        if (fee) {
            const row = e.target.closest('.seminar-row');
            const amountInput = row.querySelector('.amount-input');
            if (!amountInput.value) {
                amountInput.value = fee;
            }
        }
    }
});

// Toggle instructor payment amount input when checkbox is checked
function toggleInstructorPaymentAmount(checkbox, paymentId) {
    const amountInput = document.getElementById('instructor-payment-amount-' + paymentId);
    const idInput = document.getElementById('instructor-payment-id-' + paymentId);
    const notesInput = document.getElementById('instructor-payment-notes-' + paymentId);
    
    if (checkbox.checked) {
        amountInput.disabled = false;
        amountInput.required = true;
        amountInput.classList.remove('bg-gray-100');
        amountInput.classList.add('bg-white');
        idInput.disabled = false;
        idInput.value = paymentId;
        notesInput.disabled = false;
        notesInput.classList.remove('bg-gray-100');
        notesInput.classList.add('bg-white');
    } else {
        amountInput.disabled = true;
        amountInput.required = false;
        amountInput.classList.remove('bg-white');
        amountInput.classList.add('bg-gray-100');
        idInput.disabled = true;
        idInput.value = '';
        notesInput.disabled = true;
        notesInput.classList.remove('bg-white');
        notesInput.classList.add('bg-gray-100');
    }
}


</script>
{% endblock %}
