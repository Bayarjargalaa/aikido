# Бусад орлогын систем - Хэрэгжүүлсэн өөрчлөлтүүд

## Хийгдсэн ажлууд

### 1. **Банкны гүйлгээг холбох хэсэгт бусад орлого нэмэх боломж нэмсэн**

**Файл:** `config/aikido_app/views.py`

#### Өөрчлөлтүүд:

- **`bank_transaction_match` view** (мөр 1509+):
  - POST хүсэлт хүлээн авахад `income_type` параметрийг шалгана
  - Хэрэв `income_type == 'other_income'` бол:
    - `income_category[]` - Орлогын төрөл (одоо байгаа эсвэл шинэ)
    - `income_date[]` - Орлогын огноо
    - `amount[]` - Дүн
    - `notes[]` - Тайлбар
  - `IncomeAllocation` бичлэг үүсгэнэ
  - Гүйлгээний статусыг шинэчилнэ
  - Үлдсэн дүн шалгаж, редирект хийнэ

- **GET хүсэлт** (мөр 1657+):
  - `income_categories` - Бүх орлогын төрлүүд
  - `income_allocations` - Одоо байгаа орлогын хуваарилалтууд
  - Template-д дамжуулна

### 2. **Орлогын хуваарилалт устгах функц нэмсэн**

**Файл:** `config/aikido_app/views.py` (мөр 1491+)

```python
@login_required
def delete_income_allocation(request, allocation_id):
    """Орлогын хуваарилалт устгах"""
    allocation = get_object_or_404(IncomeAllocation, id=allocation_id)
    
    if request.method == 'POST':
        transaction_id = allocation.bank_transaction.id
        allocation.delete()
        
        # Гүйлгээний статус шинэчлэх
        transaction = BankTransaction.objects.get(id=transaction_id)
        transaction.update_status()
        
        messages.success(request, 'Орлогын хуваарилалт устгагдлаа!')
        return redirect('bank_transaction_match', transaction_id=transaction_id)
    
    return render(request, 'aikido_app/delete_income_allocation.html', {'allocation': allocation})
```

### 3. **URL patterns шинэчилсэн**

**Файл:** `config/aikido_app/urls.py`

```python
path('income-allocation/<int:allocation_id>/delete/', views.delete_income_allocation, name='delete_income_allocation'),
```

### 4. **Template өөрчлөлтүүд**

**Файл:** `config/aikido_app/templates/aikido_app/bank_transaction_match.html`

#### Нэмсэн хэсгүүд:

1. **Одоо байгаа бусад орлогын хуваарилалт харуулах** (мөр 103+):
   - Харагдах мэдээлэл: төрөл, огноо, дүн, тайлбар
   - Устгах товч (`delete_income_allocation` URL рүү холбоно)

2. **Орлогын төрөл сонгох радио товчлуур** (мөр 179+):
   - "Сурагчийн төлбөр" (анхдагч)
   - "Бусад орлого"
   - JavaScript функц `toggleIncomeForm()` дуудагдана

3. **Бусад орлогын форм** (мөр 304+):
   - Анх нуугдсан (`display: none`)
   - Талбарууд:
     - Орлогын төрөл (select dropdown + шинэ төрөл үүсгэх input)
     - Огноо (date input)
     - Дүн (number input)
     - Тайлбар (text input)
   - "Мөр нэмэх" товч
   - "Устгах" товч

4. **JavaScript функцүүд** (мөр 615+):
   - `toggleIncomeForm()`: Сурагчийн төлбөр / бусад орлого хооронд солих
   - `addIncomeRow()`: Бусад орлогын мөр нэмэх
   - `removeIncomeRow()`: Бусад орлогын мөр устгах

### 5. **Устгах баталгаажуулах template**

**Файл:** `config/aikido_app/templates/aikido_app/delete_income_allocation.html`

Энэ template нь:
- Устгах гэж буй орлогын хуваарилалтын мэдээлэл харуулна
- "Устгах" болон "Цуцлах" товчтой
- POST хүсэлт илгээж устгана

---

## Хэрэглэх заавар

### Бусад орлого холбох

1. **Банкны гүйлгээний жагсаалт** (`/bank-transactions/`) руу орох
2. **Орлого төрлийн** гүйлгээг сонгож "Холбох" дарах
3. **"Орлогын төрөл сонгох"** хэсэгт **"Бусад орлого"** радио товч сонгох
4. **Орлогын төрөл** сонгох (семинар, гишүүнчлэл, гэх мэт)
   - Эсвэл шинэ төрөл үүсгэх
5. **Огноо** оруулах (анхдагчаар гүйлгээний огноо)
6. **Дүн** оруулах
7. **Тайлбар** нэмэх (заавал биш)
8. Олон мөр нэмэх бол **"Мөр нэмэх"** товч дарах
9. **"Хадгалах"** дарах

### Бусад орлогын жагсаалт харах

1. Зүүн цэснээс **"Бусад орлого"** (`/income/`) сонгох
2. **Сараар** эсвэл **төрлөөр** шүүж харах боломжтой
3. **Нийт дүн**, **гүйлгээний тоо**, **дундаж дүн** харагдана
4. Төрөл тус бүрийн дэлгэрэнгүй мэдээлэл харагдана

### Холбосон бусад орлого засах/устгах

1. **Банкны гүйлгээний жагсаалтаас** холбосон гүйлгээг сонгож "Холбох" дарах
2. **"Одоо байгаа бусад орлогын хуваарилалт"** хэсэгт харагдана
3. **Устгах** товч дарж устгах

---

## Техникийн дэлгэрэнгүй

### Өгөгдлийн загвар

```python
class IncomeAllocation(models.Model):
    bank_transaction = ForeignKey(BankTransaction, on_delete=CASCADE, related_name='income_allocations')
    income_category = ForeignKey(IncomeCategory, on_delete=PROTECT)
    income_date = DateField()
    amount = DecimalField(max_digits=10, decimal_places=2)
    notes = TextField(blank=True)
    created_by = ForeignKey(Instructor, on_delete=SET_NULL, null=True)
    created_at = DateTimeField(auto_now_add=True)
```

### Холбогдох Models

- **`BankTransaction`**: `income_allocations` related_name ашиглана
- **`IncomeCategory`**: 6 төрлийн ангилал (SEMINAR, MEMBERSHIP, EXAM, EVENT, MERCHANDISE, OTHER)

### View Logic

1. **POST handler**:
   - `income_type` шалгаж `other_income` эсэхийг тодорхойлно
   - `income_category[]`, `new_income_category[]`, `income_date[]`, `amount[]`, `notes[]` авна
   - Шинэ ангилал үүсгэх шаардлагатай бол `get_or_create()` ашиглана
   - `IncomeAllocation` бичлэг үүсгэнэ
   - Гүйлгээний статус болон үлдсэн дүнг шинэчилнэ

2. **GET handler**:
   - `income_categories` болон `income_allocations` template-д дамжуулна
   - Одоо байгаа хуваарилалтуудыг харуулна

### JavaScript Behavior

- Radio товч өөрчлөгдөхөд `toggleIncomeForm()` дуудагдана
- Сурагчийн төлбөрийн форм эсвэл бусад орлогын форм харагдана
- Required талбарууд disabled/enabled болно
- Мөр нэмэх/устгах функцүүд динамик байдлаар ажиллана

---

## Тест хийх

1. **Банкны гүйлгээ оруулах** (credit төрлийн)
2. **"Бусад орлого" сонгож холбох**:
   - Төрөл: "Семинарын хураамж"
   - Огноо: 2025-11-16
   - Дүн: 500,000₮
3. **"Бусад орлого" жагсаалт** (`/income/`) руу орж харах
4. **Гүйлгээ дахин нээж**, одоо байгаа хуваарилалт харагдахыг баталгаажуулах
5. **Устгах товч** дарж, баталгаажуулалтын хуудас гарч ирэхийг шалгах
6. **Устгасны дараа** гүйлгээний статус шинэчлэгдэхийг шалгах

---

## Дараагийн алхамууд (хэрэгтэй бол)

1. ✅ IncomeAllocation үүсгэх логик нэмэх (ХИЙГДСЭН)
2. ✅ Template-д бусад орлогын форм нэмэх (ХИЙГДСЭН)
3. ✅ Устгах функц нэмэх (ХИЙГДСЭН)
4. ⏳ `BankTransaction.get_allocated_amount()` функцэд `income_allocations` нэмэх
5. ⏳ `BankTransaction.update_status()` функцэд `income_allocations` шалгах логик нэмэх

---

Одоо системд **3 төрлийн хуваарилалт** байна:

1. **PaymentAllocation** - Сурагчийн сарын төлбөр
2. **IncomeAllocation** - Бусад орлого (семинар, гишүүнчлэл, гэх мэт)
3. **ExpenseAllocation** - Зардал

Бүх гурван төрөл **банкны гүйлгээтэй холбогдох**, **устгах боломжтой**, **тусдаа жагсаалттай** болсон!
